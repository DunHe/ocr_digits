#! /usr/bin/env python
# -*- coding: utf-8 -*-
'''
Create on 2016-01-19 15:37:14

@author: huangzhenghua
'''

import os
import json
import cv2
import numpy as np
import argparse
from argparse import RawTextHelpFormatter
from sklearn.externals import joblib
from ocr_digits.common.traverse import traverseFolders
from ocr_digits.reco_digits.recoDigits import cropDigits
from ocr_digits.ml.classifier import accuracy_score
import shutil

description='''
    ./eval_invoice_groups --invoice ../../ocr_datasets/training_dir_groups/group10/0609145140i7gzW.jpg --classifier_path ../../ocr_trained_model/trained_model_svm/trained_model_svm.pkl
    ./eval_invoice_groups --invoice_group ../../ocr_datasets/training_dir_groups --classifier_path ../../ocr_trained_model/trained_model_svm/trained_model_svm.pkl
'''


def jsonLoad(file_path, feature, subfeature=''):
    file = open(file_path)
    jsons = json.loads(file.read())
    file.close()

    if subfeature != '':
        return jsons[feature][subfeature]
    else:
        return jsons[feature]


class Invoice:

    def __init__(self, is_debug=True, debug_dir="/tmp/invoice_debug",
                 digit_w=28, digit_h=28):
        self.daima_data = np.array([], dtype=np.uint8)
        self.daima_target = np.array([], dtype=np.uint8)
        self.haoma_data = np.array([], dtype=np.uint8)
        self.haoma_target = np.array([], dtype=np.uint8)
        self.is_debug = is_debug
        self.debug_dir = debug_dir
        self.digit_w = digit_w
        self.digit_h = digit_h

    def show_field(self, img,
                   img_path,
                   digits,
                   field_name,
                   field_x, field_y,
                   field_w, field_h,
                   ):
        key_name = field_name
        field_img = img[int(field_y): int(field_y) + int(field_h),
            int(field_x): int(field_x) + int(field_w)]
        basename = os.path.basename(img_path)
        basename = basename.replace(".jpg", "")
        field_path = os.path.join(
                self.debug_dir,
                "%s_%s.jpg" % (basename, key_name))
        cv2.imwrite(field_path, field_img)
        i = 0
        digit_shape = (self.digit_w, self.digit_h)
        for digit in digits:
            digit_path = os.path.join(
                self.debug_dir,
                "%s_%s_%d.jpg" % (basename, key_name, i))
            cv2.imwrite(digit_path, digit.reshape(digit_shape))
            i += 1

    def invoice_process(self, dir):
        if self.is_debug:
            if not os.path.isdir(self.debug_dir):
                os.makedirs(self.debug_dir)

        img = cv2.imread(dir, 0)

        daima = jsonLoad(dir+'.desc.json',
                         'fapiaodaima', 'bounding_box')
        daima_x = int(float(daima['top_left'][0]))
        daima_y = int(float(daima['top_left'][1]))
        daima_w = int(float(daima['low_right'][0])) - daima_x
        daima_h = int(float(daima['low_right'][1])) - daima_y
        daima_text = jsonLoad(dir+'.desc.json',
                'fapiaodaima', 'text').encode('utf-8')

        daima_len = 12
        if len(daima_text) == daima_len:
            digits = cropDigits(
                    img,
                    int(daima_x), int(daima_y),
                    int(daima_h), int(daima_w),
                    daima_len,
                    self.digit_w, self.digit_h)
            for i in range(daima_len):
                if len(self.daima_data) == 0:
                    self.daima_data = digits[i]
                else:
                    self.daima_data = np.vstack((self.daima_data, digits[i]))
                self.daima_target = np.hstack((self.daima_target,
                                               daima_text[i]))
            if self.is_debug:
                self.show_field(img,
                                dir,
                                digits=digits,
                                field_name="daima",
                                field_x=int(daima_x), field_y=int(daima_y),
                                field_w=int(daima_w), field_h=int(daima_h),)
                
        else:
            raise ValueError("Please correct %s. "
                "Daima len is not equal to %d " % (dir, daima_len))

        haoma = jsonLoad(dir+'.desc.json', 'fapiaohaoma', 'bounding_box')
        haoma_x = int(float(haoma['top_left'][0]))
        haoma_y = int(float(haoma['top_left'][1]))
        haoma_w = int(float(haoma['low_right'][0])) - haoma_x
        haoma_h = int(float(haoma['low_right'][1])) - haoma_y
        haoma_text = jsonLoad(dir+'.desc.json',
                'fapiaohaoma', 'text').encode('utf-8')

        haoma_len = 8
        if len(haoma_text) == haoma_len:
            digits = cropDigits(
                    img,
                    int(haoma_x), int(haoma_y),
                    int(haoma_h), int(haoma_w),
                    haoma_len)
            for i in range(haoma_len):
                if len(self.haoma_data) == 0:
                    self.haoma_data = digits[i]
                else:
                    self.haoma_data = np.vstack((self.haoma_data, digits[i]))
                self.haoma_target = np.hstack((self.haoma_target, haoma_text[i]))
            if self.is_debug:
                self.show_field(img,
                                dir,
                                digits=digits,
                                field_name="haoma",
                                field_x=int(haoma_x), field_y=int(haoma_y),
                                field_w=int(haoma_w), field_h=int(haoma_h),)
        else:
            raise ValueError("Please correct %s. "
                "haoma len is not equal to %d " % (dir, haoma_len))

    def invoice_predict(self, clf_path):
        clf = joblib.load(clf_path)
        if len(self.daima_data) != 0 and len(self.daima_target) != 0 \
           and len(self.haoma_data) != 0 and len(self.haoma_target) != 0:

            print accuracy_score(self.daima_target,
                                 clf.predict(self.daima_data))
            print accuracy_score(self.haoma_target,
                                 clf.predict(self.haoma_data))


if __name__ == "__main__":

    parser = argparse.ArgumentParser(
        description=description,
        formatter_class=RawTextHelpFormatter)

    parser.add_argument('--invoice', dest='invoice',
                        default=None, required=False,
                        help='invoice to reco')
    
    parser.add_argument('--invoice_group', dest='invoice_group',
                        default=None, required=False,
                        help='invoice group to reco')

    parser.add_argument('--classifier_path', dest='clf',
                        default=None, required=False,
                        help='classifier path')
    
    options = parser.parse_args()

    test = Invoice()

    if options.invoice:
        invoice = os.path.expanduser(options.invoice)
        test.invoice_process(invoice)
    if options.invoice_group:
        invoice_group = os.path.expanduser(options.invoice_group)
        traverseFolders(
            test.invoice_process,
            invoice_group, ftype='image')
    if options.clf:
        clf_path = os.path.expanduser(options.clf)
        test.invoice_predict(clf_path)
